spring.application.name=portfolio-service

# Local default = 8084; Render overrides via PORT
server.port=${PORT:8084}

# ---------- DB (LOCAL defaults; env can override) ----------
spring.datasource.url=${SPRING_DATASOURCE_URL:jdbc:postgresql://localhost:5432/portfolio_db}
spring.datasource.username=${SPRING_DATASOURCE_USERNAME:postgres}
spring.datasource.password=${SPRING_DATASOURCE_PASSWORD:postgres}
spring.datasource.driver-class-name=org.postgresql.Driver
spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.hibernate.ddl-auto=update
spring.jpa.open-in-view=false

# ---------- Security: resource server (local JWKS by default) ----------
spring.security.oauth2.resourceserver.jwt.jwk-set-uri=${SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI:http://localhost:8080/oauth2/jwks}

# ---------- Reporting service client (LOCAL default via gateway) ----------
clients.reporting.base-url=${CLIENTS_REPORTING_BASE_URL:http://localhost:8082/reporting-service}
clients.reporting.quotes-path=/api/quotes   # ?tickers=AAPL,MSFT

# ---------- Resilience4j CircuitBreaker ----------
resilience4j.circuitbreaker.instances.reportingClient.slidingWindowType=COUNT_BASED
resilience4j.circuitbreaker.instances.reportingClient.slidingWindowSize=50
resilience4j.circuitbreaker.instances.reportingClient.failureRateThreshold=50
resilience4j.circuitbreaker.instances.reportingClient.slowCallRateThreshold=50
resilience4j.circuitbreaker.instances.reportingClient.slowCallDurationThreshold=3s
resilience4j.circuitbreaker.instances.reportingClient.minimumNumberOfCalls=10
resilience4j.circuitbreaker.instances.reportingClient.waitDurationInOpenState=5s
resilience4j.circuitbreaker.instances.reportingClient.permittedNumberOfCallsInHalfOpenState=2
resilience4j.circuitbreaker.instances.reportingClient.recordExceptions[0]=org.springframework.web.reactive.function.client.WebClientResponseException
resilience4j.circuitbreaker.instances.reportingClient.recordExceptions[1]=java.io.IOException

# ---------- Resilience4j Retry ----------
resilience4j.retry.instances.reportingClient.maxAttempts=2
resilience4j.retry.instances.reportingClient.waitDuration=150ms
resilience4j.retry.instances.reportingClient.enableExponentialBackoff=true
resilience4j.retry.instances.reportingClient.exponentialBackoffMultiplier=2.0
resilience4j.retry.instances.reportingClient.retryExceptions[0]=org.springframework.web.reactive.function.client.WebClientResponseException$ServiceUnavailable
resilience4j.retry.instances.reportingClient.retryExceptions[1]=java.io.IOException

# ---------- Request Timeouts ----------
spring.webflux.request-timeout=5s
# spring.mvc.async.request-timeout=5s

# (Optional) debug CB state transitions during testing
logging.level.io.github.resilience4j.circuitbreaker=DEBUG

# ---------- Resilience4j TimeLimiter ----------
resilience4j.timelimiter.instances.reportingClient.timeoutDuration=2500ms

# ---------- Actuator ----------
management.endpoints.web.exposure.include=health,info,prometheus

# ---------- AI Summary / OpenAI (LOCAL defaults; key via env) ----------
ai.openai.api-base=${AI_OPENAI_API_BASE:https://api.openai.com/v1}

# no hardcoded key; comes from env
ai.openai.api-key=${AI_OPENAI_API_KEY:}

ai.openai.model=${AI_OPENAI_MODEL:gpt-4o-mini}

# true for local if you need SSL bypass (DEV ONLY)
# (no inline comments allowed on same line)
ai.openai.insecure-ssl=${AI_OPENAI_INSECURE_SSL:true}

# ---------- Cache (shared config) ----------
spring.cache.type=caffeine
spring.cache.caffeine.spec=maximumSize=1000,expireAfterWrite=60s
